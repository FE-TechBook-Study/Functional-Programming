# [Ch 1] 쏙쏙 들어오는 함수형 코딩에 오신 것을 환영합니다

**책의 목적**

- 함수형 개발자들이 부수 효과를 다루는 방법에 대해 설명한다.
- 부수 효과가 있는 함수인 액션과 부수 효과가 없는 함수인 계산을 잘 분리하는 방법을 설명한다.
- 불변형 데이터 구조를 만들어 전역 변수와 같은 부수 효과를 없애는 방법을 설명하고, 입출력과 같은 부수 효과를 순수 함수와 분리하는 방법을 배울 수 있다.
- 실무에서 작업하는 코드를 액션, 계산, 데이터로 리팩터링할 수 있다.

# 함수형 프로그래밍 (Functional Programming, FP, 명사)

1. 수학 함수를 사용하고 부수 효과를 피하는 것이 특징인 프로그래밍 패러다임
2. 부수 효과 없이 순수함수만 사용하는 프로그램이 스타일

<aside>
💡 부수 효과 종류
- 이메일 보내기
- 파일 읽기
- 불빛을 깜빡이기
- 웹 요청을 하기
- 자동차에 브레이크 밟기

</aside>

## 함수형 프로그래밍 정의의 문제점

1. 부수 효과는 필요하다.
2. 함수형 프로그래밍은 부수 효과를 잘 다룰 수 있다.
3. 함수형 프로그래밍은 실용적이다.

# 함수형 프로그래밍을 학문적 지식이 아닌 기술과 개념으로 보기

## 액션과 계산, 데이터 구분하기

### 1. 액션

- 실행 시점이나 횟수 또는 둘 다에 의존한다.
- 긴급한 메일을 오늘 보내는 것과 다음 주에 보내는 것은 완전히 다르다.

> - 시간이 지남에 따라 안전하게 상태를 바꿀 수 있는 방법

- 순서를 보장하는 방법
- 액션이 정확히 한 번만 실행되게 보장하는 방법
  >

### 2. 계산

- 입력값으로 출력값을 만드는 것이다.
- 같은 입력값을 가지고 계산하면 항상 같은 결괏값이 나온다.

> - 정확성을 위한 정적 분석

- 소프트웨어에서 쓸 수 있는 수학적 지식
- 테스트 전략
  >

### 3. 데이터

- 이벤트에 대해 기록한 사실이다.
- 실행하지 않아도 데이터 자체로 의미가 있다.

> - 효율적으로 접근하기 위해 데이터를 구성하는 방법

- 데이터를 보관하기 위한 기술
- 데이터를 이용해 중요한 것을 발견하는 원칙
  >

<aside>
💡 함수형 프로그래머는 액션보다 계산을 좋아하고 계산보다 데이터를 좋아한다.

</aside>

## 액션, 계산, 데이터를 구분하면 어떤 장점이 있나요?

### 함수형 프로그래밍은 요즘 유행하는 분산 시스템에 잘 어울린다.

<aside>
💡 분산 시스템 규칙 3가지
1. 메시지 순서가 바뀔 수 있다.
2. 메시지는 한 번 이상 도착할 수도 있고 도착하지 않을 수도 있다.
3. 응답을 받지 못하면 무슨 일이 생겼는지 알 수 없다.

</aside>

데이터와 계산은 실행 시점이나 횟수에 의존하지 않는다.

그래서 코드를 데이터와 계산으로 바꿀수록 분산 시스템에서 생기는 여러 가지 문제를 해결할 수 있다.

액션은 실행 시점과 횟수에 의존하기 때문에 여전히 문제가 되지만, 코드 전체에 영향을 주지 않도록 격리키시면 된다.

그리고 코드의 많은 부분을 액션에서 계산으로 옮기면 결과적으로 액션도 다루기 쉬워진다.

# 함수형 사고가 무엇인가요?

함수형 사고는 함수형 프로그래머가 소프트웨어 문제를 해결하기 위해 사용하는 기술과 생각을 말한다.

첫 번째는 액션과, 계산, 데이터를 구분해서 생각하는 것이고, 두 번째는 일급 추상(firrst-class abstraction)이라는 개념이다.

이 두 가지 개념은 함수형 프로그래밍으로 실용적이고 튼튼한 프로그램을 만드는 기초가 된다.

# [Ch 2] 현실에서의 함수형 사고

# 토니 피자에 오신 것을 환영합니다.

토니 가게가 어떻게 돌아가고 있는지, 또 주방과 재고 창고는 어떻게 운영되는지 살펴보고 두 개의 함수형 사고를 어떻게 적용했는지 알아본다.

## 파트 1: 액션과 계산, 데이터

### 1. 액션

액션은 호출 횟수와 시점에 의존하는 것이다.

예시:

- 반죽 펴기
- 피자 배달
- 재료 주문

### 2. 계산

계산은 어떤 것을 결정하거나 계획하는 것이다. 실행해도 다른 곳에 영향을 주지 않는다.

예시:

- 조리법에 나온 것을 두 배로 만들기
- 쇼핑 목록 결정

### 3. 데이터

데이터는 유연하기 때문에 저장하거나 네트워크로 전송하는 등 다양하게 쓸 수 있다.

예시:

- 고객 주문
- 영수증
- 조리법

## 파트2: 일급 추상

### 분산 시스템에 대해 배운 것

1. 기본적으로 타임라인은 서로 순서를 맞추지 않는다.
2. 액션이 실행되는 시간은 중요하지 않는다.
3. 드물지만 타이밍이 어긋나는 경우는 실제 일어난다.
4. 타임라인 다이어그램으로 시스템의 문제를 알 수 있다.

### 타임라인 커팅: 로봇이 서로를 기다릴 수 있게 하기

타임라인 커팅은 여러 타임라인이 동시에 진행될 때 서로 순서를 맞추는 방법이다.

타임라인 커팅은 고차 동작(high-order operation)으로 구현한다.

각 타임라인은 독립적으로 동작하고 작업이 완료되면 다른 타임라인 끝나기를 기다릭 때문에 어떤 타임라인이 먼저 끝나도 괜찮다.

예시:

- 로봇은 타임라인 커팅을 하여, 특정 작업들이 끝나기를 기다린다. 그리고 해당 작업들이 완료되면 다른 작업을 실행한다.

# 요점 정리

- 액션과 계산, 데이터를 구분하는 일은 함수형 프로그래머에게 가장 중요하고 첫 번째로 해야 하는 일이다.
- 함수형 프로그래머는 유지보수를 잘 하기 위해 계층형 설계를 사용한다.
- 타임라인 다이어그램은 시간에 따라 변하는 액션을 시각화하는 방법이다. 이를 통해 액션이 다른 액션과 어떻게 연결되는지 볼 수 있다.
- 액션 간 협력을 위해 타임라인 커팅을 한다. 타임라인 커팅은 액션이 올바른 순서로 실행할 수 있도록 보장해준다.

# [Ch 3] 액션과 계산, 데이터의 차이를 알기

# 액션과 계산, 데이터

| 액션                                                    | 계산                                         | 데이터                                                 |
| ------------------------------------------------------- | -------------------------------------------- | ------------------------------------------------------ |
| 실행 시점과 횟수에 의존                                 | 입력으로 출력 계산                           | 이벤트에 대한 사실                                     |
| 부수 효과가 있는 함수, 순수하지 않은 함수라고도 부른다. | 순수 함수, 수학 함수라고도 부른다.           |                                                        |
| 이메일 보내기, 데이터베이스 읽기                        | 최댓값 찾기, 이메일 주소가 올바른지 확인하기 | 사용자가 입력한 이메일 주소, 은행 API로 읽은 달러 수량 |

## 1. 문제에 대해 생각할 때

문제를 액션과 계산, 데이터로 나눠 생각할 수 있다.

## 2. 코딩할 때

액션이 계산이 될 수 있는지, 계산은 데이터가 될 수 있는지 고민한다.

## 3. 코드를 읽을 때

코드를 읽을 때 액션과 계산, 데이터 중 어떤 것에 속하는지 살펴봐야 한다.

# 데이터에 대해 자세히 알아보기

### 데이터는 무엇인가요?

데이터는 이벤트에 대한 사실이다. 일어난 일의 결과를 기록한 것이다.

### 데이터를 어떻게 구현하나요?

자바스크립트에서는 기본 데이터 타입으로 구현한다.

숫자나 문자, 배열, 객체 같은 것이다.

### 어떻게 데이터에 의미를 담을 수 있나요?

데이터 구조로 의미를 담을 수 있다.

예를 들어, 목록의 순서가 중요하다면 순서를 보장하는 데이터 구조를 사용하면 된다.

데이터 구조로 도메인을 표현할 수 있다.

### 불변성

함수형 프로그래머는 불변 데이터 구조를 만들기 위해 두 가지 원칙을 사용한다.

1. **카피-온-라이트(copy-on-write), 변경할 때 복사본을 만든다.**
2. **방어적 복사(defensive copy), 보관하려고 하는 데이터의 복사본을 만든다.**

### 데이터의 예

- 구입하려는 음식 목록
- 이름
- 전화번호
- 음식 조리법

### 데이터의 장점은 무엇인가요?

데이터는 데이터 자체로 할 수 있는 것이 없기 때문에 좋다. 그래서 데이터는 데이터 그대로 이애할 수 있다.

1. **직렬화**

- 직렬화된 액션과 계산은 다른 곳에서 잘 동작할 것이라는 보장이 없다. 그러나, 데이터는 전송하거나 디스크에 저장했다가 읽기 쉽다.

1. **동일성 비교**

- 계산이나 액션은 서로 비교하기 어렵다. 하지만 데이터는 비교하기 쉽다.

1. **자유로운 해석**

- 데이터는 여러 가지 방법으로 해석할 수 있다. 접속 로그는 문제 해결을 위해 사용할 수 있지만, 모니터링을 위해 사용할 수도 있다.

### 데이터의 단점은 무엇인가요?

유연하게 해석할 수 있다는 점은 장점이지만, 해석이 반드시 필요하다는 점은 단점이다.

계산은 해석하지 않아도 실행할 수 있다.

하지만 해석하지 않은 데이터는 쓸모없는 바이트일 뿐이다.

## 연습 문제

액션:

- 이메일 보내기
- 데이터베이스에서 구독자 가져오기
- 데이터베이스에서 쿠폰 읽기

계산:

- 어떤 이메일이 쿠폰을 받을지 결정하기

데이터:

- 쿠폰에 등급 매기기
- 이메일 제목, 주소, 본문
- 추천 수
- 구독자, 쿠폰, 쿠폰 목록, 구독자 목록 DB 레코드

# 쿠폰 보내는 과정 구현하기

### 데이터베이스에서 가져온 구독자 데이터

```jsx
let subscriber = {
  email: "sam@pmail.com",
  rec_count: 16,
};
```

### 쿠폰 등급은 문자열입니다.

쿠폰 등급은 데이터베이스 테이블에 있는 rank 열값과 같다.

```jsx
let rank1 = "best";
let rank2 = "good";
```

### 쿠폰 등급을 결정하는 것은 함수이다.

자바스크립트에서 계산은 함수로 구현한다. 입력값은 함수 인자이고 출력값은 함수의 리턴값이다.

```jsx
function subCouponRank(subscriber) { // 입력
	if (subscriber.rec_count >= 10) // 계산
		return 'best';
	else
		return 'good'; // 출력
```

### 데이터베이스에서 가져온 쿠폰 데이터

```jsx
let coupun = {
  code: "10PERFG",
  rank: "bad",
};
```

### 특정 등급의 쿠폰 목록을 선택하는 계산은 함수이다.

```jsx
function selectCouponsByRank(coupons, rank) {
  let ret = [];

  for (let c = 0; c < coupons.length; c++) {
    let coupon = coupons[c];
    if (coupon.rank === rank) ret.push(coupon.code);
  }

  return ret;
}
```

### 구독자가 받은 이메일을 계획하는 계산

계산이기 때문에 역시 함수로 구현한다. 외부에 어떤 영향도 주지 않고 입력값에 따라 이메일을 결정하고 리턴하는 것이 전부이다.

```jsx
function emialForSubscriber(subscriber, goods, bests) {
	let rank = subCouponRank(subscriber);

	if (rank === 'best') // 등급 결정
		return {
			from: 'newsletter@coupondog.co',
			to: subscriber.email,
			subject: 'Your best weekly coupons inside',
			body: 'Here are the best coupons: ' + bests.join(', ')
		}
	else
		return {
			from: 'newsletter@coupondog.co',
			to: subscriber.email,
			subject: 'Your good weekly coupons inside',
			body: 'Here are the good coupons: ' + goods.join(', ')
		}
```

### 보낼 이메일 목록을 준비하기

이 함수는 실행 시점에 의존하지 않으므로, 계산이다.

```jsx
function emailsForSubscribers(subscribers, goods, bests) {
  let emails = [];

  for (let s = 0; s < subscribers.length; s++) {
    // 파트 2에서 반복문 대신 map 사용 예정
    let subscriber = subscribers[s];
    let email = emailForSubscriber(subscriber, goods, bests);
    emails.push(email);
  }

  return emails;
}
```

### 이메일 보내기는 액션이다.

```jsx
function sendIssue() {
  let coupons = fetchCouponsFromDB();
  let goodCoupons = selectCouponsByRank(coupons, "good");
  let bestCoupons = selectCouponsByRank(coupons, "best");
  let subscribers = fetchSubscribersFromDB();
  let emails = emailsForSubscrbiers(subscribers, goodCoupons, bestCoupons);

  for (let e = 0; e < emails.length; e++) {
    let email = emails[e];
    emailSystem.send(email);
  }
}
```

### 일반적인 구현 순서

데이터를 파악하는 것으로 시작해서 계산과 추가 데이터를 도출한다.

그리고 액션으로 모든 것을 묶는다.

데이터는 사용하는 데 제약이 많고 액션은 가장 제약이 없다.

이와 같이 데이터를 먼저 구현하고 계산을 구현한 후에 마지막으로 액션을 구현하는 것이 함수형 프로그래밍의 일반적인 구현 순서이다.

### 사용자가 수백만 명일 경우, 액션만 고쳐서 최적화하기

page로 20개씩 묶어서 반복하면, 모든 구독자의 이메일을 얻을 수 있다.

핵심은 계산은 고치지 않았다는 것이다.

잘 만들어진 시스템이라면 ‘0보다 크거나 같은 구독자들에 대한 이메일을 가져온다’는 추상적인 개념이 바뀌지 않는 한 계산은 바뀌지 않아야 한다.

더 작은 개수를 읽도록 액션만 고쳐서 최적화하였다.

```jsx
function sendIssue() {
  let coupons = fetchCouponsFromDB();
  let goodCoupons = selectCouponsByRank(coupons, "good");
  let bestCoupons = selectCouponsByRank(coupons, "best");
  let page = 0;
  let subscribers = fetchSubscribersFromDB(page);
  while (subscribers.length > 0) {
    let emails = emailsForSubscrbiers(subscribers, goodCoupons, bestCoupons);

    for (let e = 0; e < emails.length; e++) {
      let email = emails[e];
      emailSystem.send(email);
    }

    page++;
    subscribers = fetchSubscribersFromDB(page);
  }
}
```

# 계산에 대해 자세히 알아보기

### 계산은 무엇인가요?

계산은 입력값으로 출력값을 만드는 것이다. 실행 시점과 횟수에 관계없이 항상 같은 입력값에 대해 같은 출력값을 돌려준다.

### 계산은 어떻게 구현하나요?

계산은 함수로 구현한다. 자바스크립트도 역시 함수로 계산을 구현한다.

### 어떻게 계산에 의미를 담을 수 있나요?

계산에는 연산을 담을 수 있다. 계산은 입력값을 출력값으로 만드는 것을 표현한다. 계산은 언제 사용할지 또는 어떻게 사용할지는 때에 따라 다르다.

### 왜 액션보다 계산이 좋나요?

1. 테스트하기 쉽다.
   - 계산은 언제 어디서나(로컬 장비, 빌드 서버, 테스트 장비) 원하는 만큼 테스트를 실행할 수 있다.
2. 기계적인 분석이 쉽다.
   - 정적 분석에서 자동화된 분석은 중요하다.
3. 계산은 조합하기 좋다.
   - 계산을 조합해 더 큰 계산을 만들 수 있다. 이때 일급(high-order) 계산을 사용한다.

<aside>
💡 함수형 프로그래밍의 대부분은 계산을 가지고 하는 일이다. 
계산은 일반적으로 함수형 프로그래밍 외부에 있는 액션을 통해 수행된다.

</aside>

### 계산의 예

- 더하기나 곱하기
- 문자열 합치기
- 쇼핑 계획 하기

### 계산을 쓰면서 걱정하지 않아도 되는 것

계산은 읽기 쉽고 무엇을 하는지 이해하기도 쉽다.

계산을 쓰면서 걱정하지 않아도 되는 것들은 1. 동시에 실행되는 것, 2. 과거에 실행되었던 것이나 미래에 실행할 것, 3. 실행 횟수 가 있다.

### 계산의 단점

계산과 액션은 실행하기 전에 어떤 일이 발생할지 알 수 없다는 단점이 있다.

입력값을 실행해야 결과를 알 수 있다.

# 액션에 대해 자세히 알아보기

### 액션은 무엇입니까?

액션은 외부 세계에 영향을 주거나 받는 것을 말한다. 그리고 액션은 실행 시점과 횟수에 의존한다.

- 언제 실행되는지 - 순서
- 얼마나 실행되는지 - 반복

### 액션은 어떻게 구현하나요?

자바스크립트에서 함수로 구현한다. 그러므로 계산과 구분할 줄 알아야 한다.

### 어떻게 액션에 의미를 담을 수 있나요?

액션으로 외부 세상에 영향을 줄 수 있다. 따라서 어떤 일을 하려는지 아는 것이 중요하다.

### 액션의 예

- 이메일 보내기
- 계좌에서 인출하기
- 전역변숫값 바꾸기
- ajax 요청 보내기

### 액션은 쉽지 않습니다.

- 액션은 다루기 힘들다.
- 액션은 우리가 소프트웨어를 실행하려는 가장 중요한 이유이다.

1. 가능한 액션을 적게 사용한다. 액션을 전혀 쓰지 않을 순 없다. 대신 계산을 사용할 수 있는지 생각해봐야한다.
2. 액션은 가능한 작게 만든다. 액션에서 액션과 관련없는 코드는 제거한다.
   - 액션에서 결정이나 계획과 관련된 부분은 계산으로 빼낼 수 있다.
3. 액션이 외부 세계와 상호작용하는 것을 제한할 수 있다. 내부에 계산과 데이터만 있고 가장 바깥쪽에 액션이 있는 구조가 이상적이다.
4. 액션이 호출 시점에 의존하는 것을 제한다. 함수형 프로그래머는 액션이 호출 시점과 횟수에 덜 의존하도록 만드는 기술을 알고 있다. 그래서 액션을 사용할 때 조금더 쉽게 사용할 수 있다.
