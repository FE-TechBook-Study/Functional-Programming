# ì„¸ì¤€

# íƒ€ìž„ë¼ì¸ ì‚¬ì´ì— ìžì› ê³µìœ í•˜ê¸°

ì´ ìž¥ì—ì„œëŠ” ìžì›ì„ ì•ˆì „í•˜ê²Œ ê³µìœ í•˜ê¸° ìœ„í•´ **ë™ì‹œì„± ê¸°ë³¸í˜•**ì´ë¼ëŠ” ìž¬ì‚¬ìš© ê°€ëŠ¥í•œ ì½”ë“œë¥¼ ë§Œë“œëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³¸ë‹¤.

```tsx
// action 1
...
shpping_ajax();
DOM ì—…ë°ì´íŠ¸

// action 2
...
shpping_ajax();
DOM ì—…ë°ì´íŠ¸
```

action 1ê³¼ action 2ë¥¼ ë¹ ë¥´ê²Œ ì‹¤í–‰í•œë‹¤ë©´ ì–´ë–»ê²Œ ë ê¹Œ?

1. ë™ì‹œì— ì‹¤í–‰ì€ ê±±ì •í•˜ì§€ ì•Šì•„ë„ ëœë‹¤. ìžë°”ìŠ¤í¬ë¦½íŠ¸ ì“°ë ˆë“œ ëª¨ë¸ì—ì„œ ë™ì‹œ ì‹¤í–‰ì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
2. action 1ì´ ë¨¼ì € ì™„ë£Œë˜ê³  action2ê°€ ì™„ë£Œëœë‹¤.
3. action2ê°€ ë¨¼ì € ì‹¤í–‰ë˜ê³  action 1ì´ ì‹¤í–‰ëœë‹¤.

ì˜ˆìƒí•œ ê²°ê³¼ì¸ 2ë²ˆ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì‹¤í–‰ë˜ë©´ ë¬¸ì œê°€ ì—†ê² ì§€ë§Œ, ë¹„ë™ê¸° ìš”ì²­ í›„ì— DOMì´ë¼ëŠ” ê³µìœ  ìžì›ì„ ë³€ê²½í•˜ëŠ” í–‰ìœ„ëŠ” 3ë²ˆì˜ ìœ„í—˜ì„±ë„ ê°€ì§€ê³  ìžˆë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— í•­ìƒ ìˆœì„œëŒ€ë¡œ ì—…ë°ì´íŠ¸ë˜ë„ë¡ DOM ì—…ë°ì´íŠ¸ë¥¼ ì¡°ìœ¨í•  ë°©ë²•ì´ í•„ìš”í•˜ë‹¤.

### í(Queue)

íëŠ” ë“¤ì–´ì˜¨ ìˆœì„œëŒ€ë¡œ ë‚˜ì˜¤ëŠ” ë°ì´í„° êµ¬ì¡°ë‹¤. ì•¡ì…˜ì„ ë„£ìœ¼ë©´ ë„£ëŠ” ìˆœì„œëŒ€ë¡œ êº¼ë‚¼ ìˆ˜ ìžˆë‹¤. íëŠ” ì—¬ëŸ¬ íƒ€ìž„ë¼ì¸ì— ìžˆëŠ” ì•¡ì…˜ ìˆœì„œë¥¼ ì¡°ìœ¨í•˜ê¸° ìœ„í•´ ë§Žì´ ì‚¬ìš©ëœë‹¤.

- íëŠ” ê³µìœ ìžì›ì´ì§€ë§Œ **ì•ˆì „í•˜ê²Œ ê³µìœ **ëœë‹¤.
- íì— ìžˆëŠ” ëª¨ë“  ìž‘ì—…ì€ ê°™ì€ íƒ€ìž„ë¼ì¸ ì•ˆì—ì„œ ì²˜ë¦¬ë˜ê¸° ë•Œë¬¸ì— **ìˆœì„œê°€ ê´€ë¦¬**ëœë‹¤.
- íëŠ” ìžë£Œêµ¬ì¡°ì§€ë§Œ íƒ€ìž„ë¼ì¸ ì¡°ìœ¨ì— ì‚¬ìš©í•œë‹¤ë©´ `ë™ì‹œì„± ê¸°ë³¸í˜•`ì´ë¼ê³  ë¶€ë¥¸ë‹¤. ì´ëŠ” ìžì›ì„ ì•ˆì „í•˜ê²Œ ê³µìœ í•  ìˆ˜ ìžˆëŠ” ìž¬ì‚¬ìš© ê°€ëŠ¥í•œ ì½”ë“œë¥¼ ë§í•œë‹¤.

### ìžë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ í ë§Œë“¤ê¸°

```tsx
const queue_item = []; // í ìƒì„±
let working = false; // ë™ì‹œì„±ì„ ì œì–´í•´ ì¤„ í”Œëž˜ê·¸ ì„¤ì •

function runNext() {
  // ìž‘ì—…ì¤‘ì´ë©´ ì¢…ë£Œ
  if (working) return;

  // íê°€ ë¹„ì›Œì§€ë©´ ì¢…ë£Œ
  if (queue_item.length === 0) return;

  working = true;

  const cart = queue_item.shift(); // í ì²« ë²ˆì§¸ ìš”ì†Œ

  calc_cart_total(cart, total => {
    update_total_dom(total); // ë¹„ë™ê¸°
    working = false;
    runNext();
  });
}

function update_total_queue(cart) {
  queue_item.push();
}
```

ìœ„ ì½”ë“œì—ì„œëŠ” ì „ì—­ë³€ìˆ˜ ë‘ ê°œ ìžˆë‹¤ëŠ” ë¬¸ì œê°€ ìžˆë‹¤. ì „ì—­ë³€ìˆ˜ëŠ” ìž ìž¬ì ìœ¼ë¡œ ë¬¸ì œê°€ ë  ìˆ˜ ìžˆê¸° ë•Œë¬¸ì— ì—†ì• ë³´ìž.

```tsx
function Queue() {
  const queue_item = []; // í ìƒì„±
  let working = false; // ë™ì‹œì„±ì„ ì œì–´í•´ ì¤„ í”Œëž˜ê·¸ ì„¤ì •

  function runNext() {
    // ìž‘ì—…ì¤‘ì´ë©´ ì¢…ë£Œ
    if (working) return;

    // íê°€ ë¹„ì›Œì§€ë©´ ì¢…ë£Œ
    if (queue_item.length === 0) return;

    working = true;

    const cart = queue_item.shift(); // í ì²« ë²ˆì§¸ ìš”ì†Œ

    calc_cart_total(cart, total => {
      update_total_dom(total); // ë¹„ë™ê¸°
      working = false;
      runNext();
    });
  }

  function update_total_queue(cart) {
    queue_item.push();
  }
}
```

ëª¨ë“  ì „ì—­ë³€ìˆ˜ë¥¼ `Queue()` ë²”ìœ„ë¡œ ë„£ì—ˆê¸° ë•Œë¬¸ì— ë”ëŠ” Queue() ë°–ì—ì„œ ë³€ê²½í•  ìˆ˜ ì—†ë‹¤.

## íë¥¼ ìž¬ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ ë§Œë“¤ê¸°

1. íì—ì„œ ì‹¤í–‰í•˜ëŠ” ì›Œì»¤ë¥¼ ì½œë°±ìœ¼ë¡œ ì „ë‹¬ ë°›ì„ ìˆ˜ ìžˆë„ë¡ ìˆ˜ì •

```tsx
function Queue(worker) {
  const queue_item = [];
  let working = false;

  function runNext() {
    if (working) return;
    if (queue_item.length === 0) return;

    working = true;

    const cart = queue_item.shift();

    function worker(cart, done) {}

    worker(cart, () => {
      working = false;
      runNext();
    });
  }

  function update_total_queue(cart) {
    queue_item.push();
  }
}

function calc_cart_worker(cart, done) {
  calc_cart_total(cart, total => {
    update_total_dom(total);
    done(total);
  });
}

const update_total_queue = Queue(calc_cart_worker);
```

1. í í•¨ìˆ˜ì—ì„œ cartì— ëŒ€í•œ ì˜ì¡´ì„±ì„ ì§€ìš°ê³  ë°ì´í„°ì™€ ì½œë°±ì„ ë°›ì„ ìˆ˜ ìžˆë„ë¡ ìˆ˜ì •

```tsx
const Queue = (worker) => {
	const queue_items = [];
	let working = false;

	const runNext = () =>{
		if(working) return;
		if(queue_items.length === 0) return ;

		working = true;

		const firstItem = queue_items.shift();

		worker(item.data, () => {
			wokring = false;
			runNext();
		})
	}

	return (data, callback) => {
		queue_items.push({
			data,
			callback: callback || () => {}
		})
		setTimeout(runNext, 0);
	}
}

const calc_cart_worker = (cart, done) => {
	calc_cart_total(cart, () => {
		update_total_dom(total);
		done(total);
	})
}

const update_total_queue = Queue(calc_cart_worker);
```

1. ìž‘ì—…ì´ ì™„ë£Œë˜ì—ˆì„ ë•Œ ì½œë°± ë¶ˆëŸ¬ì˜¤ê¸°

```tsx
const Queue = (worker) => {
	const queue_items = [];
	let working = false;

	const runNext = () =>{
		if(working) return;
		if(queue_items.length === 0) return ;

		working = true;

		const firstItem = queue_items.shift();

		// item.callback ì‹¤í–‰
		worker(item.data, (val) => {
			wokring = false;
			setTimeout(item.callback, 0 , val)
			runNext();
		})
	}

	return (data, callback) => {
		queue_items.push({
			data,
			callback: callback || () => {}
		})
		setTimeout(runNext, 0);
	}
}

const calc_cart_worker = (cart, done) => {
	calc_cart_total(cart, (total) => {
		update_total_dom(total);
		done(total);
	})
}

const update_total_queue = Queue(calc_cart_worker);

update_total_queue({
	data:cart,
})

update_total_queue({
	data:cart,
})

update_total_queue({
	data:cart,
})

```

```tsx
const Queue = worker => {
  let task = [];
  let lock = false;

  const runNext = () => {
    if (lock) return;
    if (task.length === 0) return;

    lock = true;
    const next = task.shift();
    console.log(performance.now(), 'working');

    worker(next.data, val => {
      lock = false;
      setTimeout(next.callback, 0, val);
    });
  };

  return (data, callback) => {
    task.push({ data, callback: callback || function () {} });
    console.log(performance.now(), 'pushed');
    setTimeout(runNext, 0);
  };
};

const console_worker = (data, done) => {
  console.log(performance.now(), 'worker');
  done();
};

const run_queue = Queue(console_worker);

run_queue(1, () => console.log(performance.now(), 'done'));
run_queue(2, () => console.log(performance.now(), 'done'));
run_queue(3, () => console.log(performance.now(), 'done'));
run_queue(4, () => console.log(performance.now(), 'done'));

// 13.824833 pushed
// 18.81325 pushed
// 18.856 pushed
// 18.884083 pushed
// 19.461583 working
// 19.502667 worker
// 19.557333 working
// 19.586167 worker
// 19.618 working
// 19.72875 worker
// 19.853208 working
// 19.892458 worker
// 20.068208 done
// 20.115833 done
// 20.147958 done
// 20.24975 done
```

---

## ë ˆì´ìŠ¤ ì»¨ë””ì…˜

ë™ì‹œì„± ë¬¸ì œëŠ” ì—¬ëŸ¬ ë¹„ë™ê¸° ìž‘ì—…ì´ ë™ì‹œì— ì‹¤í–‰ë˜ë©´ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œë¡œ, ì£¼ë¡œ ë ˆì´ìŠ¤ ì»¨ë””ì…˜(Race Condition)ìœ¼ë¡œ ë‚˜íƒ€ë‚œë‹¤.

ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì€ ë‘ ê°œ ì´ìƒì˜ ë¹„ë™ê¸° ìž‘ì—…ì´ ë™ì‹œì— ì‹¤í–‰ë˜ë©´ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ë¥¼ ì´ˆëž˜í•˜ëŠ” ìƒí™©ì„ ë§í•œë‹¤.

ì´ëŠ” ì£¼ë¡œ ê³µìœ  ìžì›ì— ëŒ€í•œ ì ‘ê·¼ì´ ì œëŒ€ë¡œ ì œì–´ë˜ì§€ ì•Šì„ ë•Œ ë°œìƒí•œë‹¤.

### ì›ì¸

1. ë¶ˆì¶©ë¶„í•œ ë™ê¸°í™”

   ì—¬ëŸ¬ ìŠ¤ë ˆë“œ ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ê°€ ì ì ˆí•œ ë™ê¸°í™” ì—†ì´ ê³µìœ  ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤í•˜ë©´ Race Conditionì´ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.

2. ì‹¤í–‰ ìˆœì„œì— ëŒ€í•œ ìž˜ëª»ëœ ê°€ì •

   í”„ë¡œê·¸ëž˜ë¨¸ê°€ ê°•ì œí•˜ì§€ ì•Šê³  íŠ¹ì • ì‹¤í–‰ ìˆœì„œë¥¼ ê°€ì •í•  ë•Œ ì‹¤ì œ ì‹¤í–‰ ìˆœì„œê°€ ë‹¤ë¥¼ ê²½ìš° Race Conditionì´ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.

`promise.all()`

[[JS/Eslint] ë ˆì´ìŠ¤ì»¨ë””ì…˜ì„ ìœ ë°œí•˜ëŠ” awaitëŠ” ì“°ì§€ë§ìž(require-atomic-updates)](https://mong-blog.tistory.com/entry/JSEslint-ë ˆì´ìŠ¤ì»¨ë””ì…˜ì„-ìœ ë°œí•˜ëŠ”-awaitëŠ”-ì“°ì§€ë§ìžrequire-atomic-updates)

`í”Œëž˜ê·¸` ê°’ì„ ì‚¬ìš©í•œ í•´ê²° â†’ ê²€ìƒ‰ ë¡œì§ ê°™ì€ ê²½ìš° ë¶€ì í•© (ì»´í¬ë„ŒíŠ¸ ë¸”ë¡)

[í”„ë¡ íŠ¸ì—”ë“œì™€ Race Condition](https://velog.io/@pjc0247/í”„ë¡ íŠ¸ì—”ë“œì™€-Race-Condition)

search ê¸°ëŠ¥

1. `async await` ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
2. ë®¤í…ìŠ¤ì™€ ê°™ì€ ë™ê¸°í™” ë§¤ì»¤ë‹ˆì¦˜

```tsx
class Mutex {
  constructor() {
    this.queue = [];
    this.locked = false;
  }

  lock() {
    return new Promise(resolve => {
      if (this.locked) {
        this.queue.push(resolve);
      } else {
        this.locked = true;
        resolve();
      }
    });
  }

  unlock() {
    if (this.queue.length > 0) {
      const resolve = this.queue.shift();
      resolve();
    } else {
      this.locked = false;
    }
  }
}

const mutex = new Mutex();

async function criticalSection() {
  await mutex.lock();
  // ê³µìœ  ìžì›ì— ì ‘ê·¼
  mutex.unlock();
}
```

> ë®¤í…ìŠ¤(Mutex, Mutual Exclusion)ëŠ” `ë‹¤ì¤‘ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ê³µìœ  ìžì›ì— ëŒ€í•œ ì ‘ê·¼ì„ ë™ê¸°í™”`í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ê¸°ë²•ìž…ë‹ˆë‹¤. ë®¤í…ìŠ¤ëŠ” íŠ¹ì • ìžì›ì— ëŒ€í•œ ë‹¨ë… ì ‘ê·¼ì„ ë³´ìž¥í•˜ì—¬, ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ìžì›ì— ì ‘ê·¼í•  ë•Œ ë°œìƒí•  ìˆ˜ ìžˆëŠ” ë°ì´í„° ë¶ˆì¼ì¹˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

1. ë¹„ë™ê¸° ìž‘ì—…ì„ `í`ì— ë„£ê³  ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•

---

ìžë°”ìŠ¤í¬ë¦½íŠ¸ ìŠ¤ë ˆë“œëŠ” í•˜ë‚˜ë‹¤. íƒ€ìž„ë¼ì¸ì€ ë‹¤ë¥¸ íƒ€ìž„ë¼ì¸ì´ ì‚¬ìž‘ë˜ê¸° ì „ì— ì™„ë£Œëœë‹¤. `cut`ì€ ì´ëŸ° ìž¥ì ì„ í™œìš©í•´ ë³€ê²½í•  ìˆ˜ ìžˆëŠ” ê°’ì„ ì•ˆì „í•˜ê²Œ ê³µìœ í•œë‹¤. ë‹¤ë¥¸ ì–¸ì–´ì—ì„œëŠ” íƒ€ìž„ë¼ì¸ì„ ì¡°ìœ¨í•˜ê¸° ìœ„í•´ ë½ì´ë‚˜ ë‹¤ë¥¸ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

## Cut()ì„ ì‚¬ìš©í•  ë•Œ ê³ ë ¤ ì‚¬í•­

### 1. Cut()ì„ ë³´ê´€í•  ë²”ìœ„

ì‘ë‹µ ì½œë°± ëì—ì„œ ë¹„ë™ê¸° í•¨ìˆ˜ê°€ ëë‚¬ìŒì„ ì•Œë¦¬ëŠ” `done()`ì„ ë¶ˆëŸ¬ì•¼ í•œë‹¤. ë”°ë¼ì„œ ë‘ ì‘ë‹µ ì½œë°±ì„ ë§Œë“œëŠ” í•¨ìˆ˜ ë²”ìœ„ì— Cut()ì„ ë§Œë“œëŠ” ê²ƒì´ ì¢‹ë‹¤.

### 2. Cut()ì— ì–´ë–¤ ì½œë°±ì„ ë„£ì„ì§€

Cut()ì€ ì–´ë–¤ ê²ƒì„ í˜¸ì¶œí•˜ëŠ”ì§€ëŠ” ìƒê´€ì´ ì—†ë‹¤.

```tsx
const cut = (count, callback) => {
  let finishedCount = 0;

  return () => {
    finishedCount++;
    if (finishedCount === count) {
      callback();
    }
  };
};

const waiting = time => {
  return new Promise(resolve => {
    setTimeout(() => {
      resolve('End waiting');
    }, time);
  });
};

const test = () => {
  const done = cut(3, () => {
    console.log('done');
  });

  waiting(1000).then(done);
  waiting(2000).then(done);
  waiting(3000).then(done);
};

test();
```

<aside>
ðŸ’¡ Promiseë¥¼ ì™œ ì•ˆì”€?

</aside>

- `Promise()`ëŠ” ìžë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ êµ¬í˜„ëœ ë™ì‹œì„± ê¸°ë³¸í˜•ì´ë‹¤.
- ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì´ë¯¸ ì•Œê³  ìžˆëŠ” ê¸°ë³¸í˜•ì´ ìžˆë‹¤ëŠ” ê·¸ê²ƒì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
- ê·¸ëƒ¥ í•¨ìˆ˜í˜•ì— ì´ëŸ° ë°©ë²•ì´ ìžˆë‹¤. ì–´ë–¤ ì†Œí”„íŠ¸ì›¨ì–´ ë¬¸ì œë¥¼ ë§Œë‚˜ë„ ì´ëŸ° ì›ì¹™ì„ ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ ë³´ì—¬ì£¼ë ¤ê³  í•œê±°ë‹¤.

## í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ justOnce()

ìµœì´ˆ í•œ ë²ˆë§Œ íš¨ê³¼ê°€ ë°œìƒí•˜ëŠ” ì•¡ì…˜ì„ `ë©±ë“±ì›` ì´ë¼ê³  í•œë‹¤. `JustOnce()`ëŠ” ì–´ë–¤ ì•¡ì…˜ì´ë“  ë©±ë“±ì›ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìžˆë‹¤.

```tsx
const justOnce = action => {
  let alreadyCalled = false;
  return (...args) => {
    if (alreadyCalled) return;
    alreadyCalled = true;
    return action(...args);
  };
};

const worker = (...args) => {
  console.log(...args);
};

const run = justOnce(worker);

run('first');
run('seconde');
run('third');

// 'first'
```
